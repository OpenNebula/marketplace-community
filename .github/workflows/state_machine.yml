name: Process Issue State

on:
  pull_request:
    types:
      - labeled

jobs:
  do-changes:
    if: startsWith(github.event.label.name, 'do_changes')
    runs-on: ubuntu-latest
    steps:
      - name: Remove current labels
        uses: issue-ops/labeler@v2.0.0
        with:
          action: remove
          issue_number: ${{ github.event.issue.number }}
          labels: | 
            do_changes
            FAILED_TESTING

      - name: Add new label
        uses: issue-ops/labeler@v2.0.0
        with:
          action: add
          issue_number: ${{ github.event.issue.number }}
          labels: "CHANGES_REQUESTED"

  do-tests:
    if: startsWith(github.event.label.name, 'do_tests')
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Trigger Jenkins
        run: |
          ssh -i ~/.ssh/id_rsa gitact@${{ secrets.VPN_SERVER }} "curl -X POST $secrets.JENKINS_URL/job/one-community-distro/buildWithParameters?token=${{ secrets.ONE_DISTRO_TOKEN }} \
            --user ${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}
            --data DISTROS=${{ github.event.pull_request.title }} \
            --data PR_NUMBER=${{ github.event.pull_request.number }}"

      - name: Remove current labels
        uses: issue-ops/labeler@v2.0.0
        with:
          action: remove
          issue_number: ${{ github.event.issue.number }}
          labels: | 
            do_tests
            CHANGES_REQUESTED

      - name: Add new label
        uses: issue-ops/labeler@v2.0.0
        with:
          action: add
          issue_number: ${{ github.event.issue.number }}
          labels: "IN_TESTING"
